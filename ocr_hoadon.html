<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xu·∫•t Th√¥ng Tin H√≥a ƒê∆°n Si√™u Th·ªã - OCR</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, getDoc, collection, query, where, getDocs,deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, addDoc, getDoc, collection, query, where, getDocs,deleteDoc, serverTimestamp
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .card { background-color: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); padding: 24px; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-primary { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4); }
        .btn-secondary { background-color: #f1f5f9; color: #475569; transition: background-color 0.2s ease; }
        .btn-secondary:hover { background-color: #e2e8f0; }
        .upload-area { border: 2px dashed #cbd5e1; transition: border-color 0.2s ease, background-color 0.2s ease; }
        .upload-area:hover { border-color: #667eea; background-color: #f8fafc; }
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4facfe; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-button {
            @apply px-4 py-2 text-gray-600 font-semibold rounded-lg transition-colors;
        }
        .tab-button.active {
            @apply bg-blue-50 text-blue-700;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">
    <div class="container">
        <header class="text-center mb-12">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-2">üßæ Tr√≠ch Xu·∫•t Th√¥ng Tin H√≥a ƒê∆°n</h1>
            <p class="text-gray-500 text-lg">S·ª≠ d·ª•ng c√¥ng ngh·ªá OCR & AI ƒë·ªÉ ph√¢n t√≠ch d·ªØ li·ªáu h√≥a ƒë∆°n c·ªßa b·∫°n.</p>
        </header>

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Left Section (Tabs) -->
            <div class="card">
                <div class="flex border-b border-gray-200 mb-6">
                    <button id="inputTab" class="tab-button active">T·∫£i l√™n & Ph√¢n t√≠ch</button>
                    <button id="searchTab" class="tab-button">H√≥a ƒë∆°n ƒë√£ l∆∞u</button>
                </div>
                
                <!-- Input/Upload Section -->
                <div id="inputSection">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">T·∫£i l√™n h√≥a ƒë∆°n</h2>
                    <select id="languageSelect" class="bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm w-full mb-4">
                        <option value="auto">T·ª± ƒë·ªông nh·∫≠n di·ªán</option>
                        <option value="eng">English</option>
                        <option value="vie">Ti·∫øng Vi·ªát</option>
                    </select>
                    
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <button id="cameraBtn" class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                            üì∏ Ch·ª•p ·∫¢nh
                        </button>
                        <button onclick="document.getElementById('fileInput').click()" class="bg-gray-500 text-white p-3 rounded-lg hover:bg-gray-600 transition-colors text-sm">
                            üìÅ Ch·ªçn File
                        </button>
                        <button id="voiceBtn" class="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-colors text-sm">
                            üé§ Gi·ªçng N√≥i
                        </button>
                    </div>
                    
                    <div class="upload-area rounded-lg p-8 text-center cursor-pointer" onclick="document.getElementById('fileInput').click()">
                        <div class="text-5xl text-gray-400 mb-4">üì∑</div>
                        <p class="text-xl font-medium text-gray-700 mb-2">K√©o th·∫£ file v√†o ƒë√¢y</p>
                        <p class="text-gray-400 text-sm">Ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn file</p>
                        <input type="file" id="fileInput" accept="image/*,.pdf" class="hidden" onchange="handleFileUpload(event)">
                    </div>
                    
                    <!-- Camera Modal -->
                    <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 class="text-lg font-semibold mb-4">Ch·ª•p ·∫¢nh H√≥a ƒê∆°n</h3>
                                <video id="cameraVideo" class="w-full rounded mb-4" autoplay></video>
                                <canvas id="cameraCanvas" class="hidden"></canvas>
                                <div class="flex gap-2">
                                    <button id="captureBtn" class="flex-1 bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600">
                                        üì∏ Ch·ª•p
                                    </button>
                                    <button id="closeCameraBtn" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
                                        ‚ùå ƒê√≥ng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Voice Modal -->
                    <div id="voiceModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <h3 class="text-lg font-semibold mb-4">Nh·∫≠p H√≥a ƒê∆°n B·∫±ng Gi·ªçng N√≥i</h3>
                                <div class="text-center mb-4">
                                    <div id="voiceStatus" class="text-gray-600 mb-2">Nh·∫•n n√∫t ƒë·ªÉ b·∫Øt ƒë·∫ßu n√≥i</div>
                                    <div id="voiceAnimation" class="hidden">
                                        <div class="w-16 h-16 mx-auto bg-red-500 rounded-full animate-pulse flex items-center justify-center">
                                            üé§
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-gray-100 p-3 rounded mb-4 min-h-20">
                                    <div class="text-sm text-gray-500 mb-1">VƒÉn b·∫£n nh·∫≠n di·ªán:</div>
                                    <div id="voiceText" class="text-gray-800">Ch∆∞a c√≥ d·ªØ li·ªáu...</div>
                                </div>
                                <div class="text-xs text-gray-500 mb-4">
                                    üí° N√≥i theo m·∫´u: "C·ª≠a h√†ng ABC, ng√†y 15/12/2024, t·ªïng ti·ªÅn 150000"
                                </div>
                                <div class="flex gap-2">
                                    <button id="startVoiceBtn" class="flex-1 bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">
                                        üé§ B·∫Øt ƒê·∫ßu
                                    </button>
                                    <button id="processVoiceBtn" class="flex-1 bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 hidden">
                                        ‚ú® X·ª≠ L√Ω
                                    </button>
                                    <button id="closeVoiceBtn" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
                                        ‚ùå ƒê√≥ng
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="previewContainer" class="mt-6 hidden">
                        <img id="previewImage" class="w-full max-h-80 object-contain rounded-lg mb-4 shadow-sm" alt="Preview">
                        <button id="processBtn" class="btn-primary text-white font-medium py-3 px-6 rounded-lg w-full">
                            ‚ú® Ph√¢n T√≠ch H√≥a ƒê∆°n
                        </button>
                    </div>
                </div>

                <!-- Search Section -->
                <div id="searchSection" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">Tra c·ª©u h√≥a ƒë∆°n ƒë√£ l∆∞u</h2>
                    <input type="text" id="searchBox" placeholder="T√¨m ki·∫øm theo t√™n c·ª≠a h√†ng ho·∫∑c ng√†y..." class="w-full border border-gray-300 rounded-lg p-2 text-gray-700 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="savedBillsContainer" class="max-h-96 overflow-y-auto">
                        <p class="text-center text-gray-400 py-4">S·ª≠ d·ª•ng √¥ t√¨m ki·∫øm ph√≠a tr√™n ƒë·ªÉ tra c·ª©u.</p>
                    </div>
                </div>

                <div id="loadingSection" class="text-center py-8 hidden">
                    <div class="loading-spinner mx-auto"></div>
                    <p class="text-gray-500 mt-4">ƒêang x·ª≠ l√Ω h√¨nh ·∫£nh...</p>
                </div>
            </div>

            <!-- Right Section (Results) -->
            <div class="card">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Th√¥ng Tin H√≥a ƒê∆°n</h2>
                    <div class="flex space-x-2">
                        <button id="copyBtn" class="btn-secondary text-gray-700 font-medium py-2 px-4 rounded-lg text-sm hidden">üìã Sao ch√©p</button>
                        <button id="exportBtn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg text-sm hidden">üìä Xu·∫•t Excel</button>
                        <button id="saveExpenseBtn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg text-sm hidden">üí∞ L∆∞u Chi Ti√™u</button>
                        <button id="saveBtn" class="btn-primary text-white font-medium py-2 px-4 rounded-lg text-sm hidden">üíæ L∆∞u H√≥a ƒê∆°n</button>
                    </div>
                </div>

                <div id="resultsContent" class="space-y-4 text-gray-700">
                    <div class="text-center text-gray-400 py-16">
                        <div class="text-5xl mb-4">üìã</div>
                        <p>T·∫£i l√™n h√¨nh ·∫£nh h√≥a ƒë∆°n ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFile = null;
        let currentReceiptInfo = null;
        let currentRawText = null;
        let db;
        let auth;
        let userId;

        document.addEventListener('DOMContentLoaded', async () => {
            // Kh·ªüi t·∫°o Firebase
            const firebaseConfig = {
  apiKey: "AIzaSyDousMef4BCkpjkH2NNsPYYt5pywPneE-U",
  authDomain: "hoadonocr-696fb.firebaseapp.com",
  projectId: "hoadonocr-696fb",
  storageBucket: "hoadonocr-696fb.firebasestorage.app",
  messagingSenderId: "502220052225",
  appId: "1:502220052225:web:e8ea301cfbbb60c93ead00",
  measurementId: "G-B1FFZ64H5N"
};
            const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, getFirestore } = window.firebase;
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    await signInAnonymously(auth);
                }
            });

            // G·∫Øn s·ª± ki·ªán cho c√°c n√∫t
            document.getElementById('inputTab').addEventListener('click', () => switchTab('input'));
            document.getElementById('searchTab').addEventListener('click', () => switchTab('search'));
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('cameraBtn').addEventListener('click', openCamera);
            document.getElementById('captureBtn').addEventListener('click', capturePhoto);
            document.getElementById('closeCameraBtn').addEventListener('click', closeCamera);
            document.getElementById('voiceBtn').addEventListener('click', openVoice);
            document.getElementById('startVoiceBtn').addEventListener('click', startVoiceRecognition);
            document.getElementById('processVoiceBtn').addEventListener('click', processVoiceInput);
            document.getElementById('closeVoiceBtn').addEventListener('click', closeVoice);
            document.getElementById('processBtn').addEventListener('click', processImage);
            document.getElementById('copyBtn').addEventListener('click', copyToClipboard);
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('saveExpenseBtn').addEventListener('click', saveToExpense);
            document.getElementById('saveBtn').addEventListener('click', saveReceipt);
            document.getElementById('searchBox').addEventListener('input', loadSavedBills);
            
            // T·∫£i h√≥a ƒë∆°n ƒë√£ l∆∞u ban ƒë·∫ßu
            loadSavedBills();
        });

        // H√†m chuy·ªÉn ƒë·ªïi tab
        function switchTab(tab) {
            const inputSection = document.getElementById('inputSection');
            const searchSection = document.getElementById('searchSection');
            const inputTabBtn = document.getElementById('inputTab');
            const searchTabBtn = document.getElementById('searchTab');
            const resultsContent = document.getElementById('resultsContent');

            if (tab === 'input') {
                inputSection.classList.remove('hidden');
                searchSection.classList.add('hidden');
                inputTabBtn.classList.add('active');
                searchTabBtn.classList.remove('active');
                if (uploadedFile) {
                    displayResults(currentReceiptInfo, currentRawText);
                } else {
                    resultsContent.innerHTML = `<div class="text-center text-gray-400 py-16"><div class="text-5xl mb-4">üìã</div><p>T·∫£i l√™n h√¨nh ·∫£nh h√≥a ƒë∆°n ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch</p></div>`;
                    document.getElementById('copyBtn').classList.add('hidden');
                    document.getElementById('exportBtn').classList.add('hidden');
                    document.getElementById('saveBtn').classList.add('hidden');
                }
            } else {
                inputSection.classList.add('hidden');
                searchSection.classList.remove('hidden');
                inputTabBtn.classList.remove('active');
                searchTabBtn.classList.add('active');
                resultsContent.innerHTML = `<div class="text-center text-gray-400 py-16"><div class="text-5xl mb-4">üìã</div><p>Ch·ªçn m·ªôt h√≥a ƒë∆°n ƒë√£ l∆∞u ƒë·ªÉ xem.</p></div>`;
                loadSavedBills();
            }
        }

        let cameraStream = null;
        let recognition = null;
        let voiceText = '';
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            setUploadedFile(file);
        }
        
        function setUploadedFile(file) {
            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                clearResults();
            };
            reader.readAsDataURL(file);
        }
        
        async function openCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Camera sau
                });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraModal').classList.remove('hidden');
            } catch (error) {
                console.error('L·ªói camera:', error);
                alert('Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p camera.');
            }
        }
        
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('cameraCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            canvas.toBlob(blob => {
                const file = new File([blob], 'camera-photo.jpg', { type: 'image/jpeg' });
                setUploadedFile(file);
                closeCamera();
            }, 'image/jpeg', 0.8);
        }
        
        function closeCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraModal').classList.add('hidden');
        }
        
        function openVoice() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i!');
                return;
            }
            document.getElementById('voiceModal').classList.remove('hidden');
            document.getElementById('voiceText').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu...';
            document.getElementById('processVoiceBtn').classList.add('hidden');
        }
        
        function startVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.lang = 'vi-VN';
            recognition.continuous = true;
            recognition.interimResults = true;
            
            recognition.onstart = () => {
                document.getElementById('voiceStatus').textContent = 'ƒêang nghe... H√£y n√≥i th√¥ng tin h√≥a ƒë∆°n';
                document.getElementById('voiceAnimation').classList.remove('hidden');
                document.getElementById('startVoiceBtn').textContent = '‚èπÔ∏è D·ª´ng';
                document.getElementById('startVoiceBtn').onclick = stopVoiceRecognition;
            };
            
            recognition.onresult = (event) => {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                voiceText = finalTranscript || interimTranscript;
                document.getElementById('voiceText').textContent = voiceText || 'ƒêang nghe...';
                
                if (finalTranscript) {
                    document.getElementById('processVoiceBtn').classList.remove('hidden');
                }
            };
            
            recognition.onerror = (event) => {
                console.error('L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i:', event.error);
                document.getElementById('voiceStatus').textContent = 'L·ªói: ' + event.error;
                stopVoiceRecognition();
            };
            
            recognition.start();
        }
        
        function stopVoiceRecognition() {
            if (recognition) {
                recognition.stop();
            }
            document.getElementById('voiceStatus').textContent = 'ƒê√£ d·ª´ng nghe';
            document.getElementById('voiceAnimation').classList.add('hidden');
            document.getElementById('startVoiceBtn').textContent = 'üé§ B·∫Øt ƒê·∫ßu';
            document.getElementById('startVoiceBtn').onclick = startVoiceRecognition;
            if (voiceText) {
                document.getElementById('processVoiceBtn').classList.remove('hidden');
            }
        }
        
        function processVoiceInput() {
            if (!voiceText) {
                alert('Ch∆∞a c√≥ d·ªØ li·ªáu gi·ªçng n√≥i!');
                return;
            }
            
            const parsedData = parseVoiceToReceipt(voiceText);
            currentReceiptInfo = parsedData;
            currentRawText = voiceText;
            
            displayResults(parsedData, voiceText);
            closeVoice();
            
            document.getElementById('copyBtn').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            document.getElementById('saveExpenseBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.remove('hidden');
        }
        
        function parseVoiceToReceipt(text) {
            const lowerText = text.toLowerCase();
            
            // T√¨m t√™n c·ª≠a h√†ng
            let storeName = '';
            const storePatterns = [
                /c·ª≠a h√†ng ([^,]+)/i,
                /si√™u th·ªã ([^,]+)/i,
                /shop ([^,]+)/i,
                /t·∫°i ([^,]+)/i
            ];
            for (const pattern of storePatterns) {
                const match = text.match(pattern);
                if (match) {
                    storeName = match[1].trim();
                    break;
                }
            }
            
            // T√¨m ng√†y
            let date = '';
            const dateMatch = text.match(/(\d{1,2})[\s\/\-](\d{1,2})[\s\/\-](\d{2,4})/);
            if (dateMatch) {
                const day = dateMatch[1].padStart(2, '0');
                const month = dateMatch[2].padStart(2, '0');
                let year = dateMatch[3];
                if (year.length === 2) year = '20' + year;
                date = `${year}-${month}-${day}`;
            }
            
            // T√¨m t·ªïng ti·ªÅn - c·∫£i thi·ªán
            let total = 0;
            
            // Chuy·ªÉn ƒë·ªïi s·ªë b·∫±ng ch·ªØ th√†nh s·ªë
            const textToNumber = {
                'm·ªôt': '1', 'hai': '2', 'ba': '3', 'b·ªën': '4', 'nƒÉm': '5',
                's√°u': '6', 'b·∫£y': '7', 't√°m': '8', 'ch√≠n': '9', 'm∆∞·ªùi': '10',
                'trƒÉm': '00', 'ngh√¨n': '000', 'ng√†n': '000', 'tri·ªáu': '000000'
            };
            
            let processedText = text.toLowerCase();
            for (const [word, num] of Object.entries(textToNumber)) {
                processedText = processedText.replace(new RegExp(word, 'g'), num);
            }
            
            const moneyPatterns = [
                /t·ªïng\s*(?:ti·ªÅn|c·ªông|s·ªë ti·ªÅn)?\s*(\d+(?:[,.]?\d{3})*)/i,
                /(?:l√†|b·∫±ng|c√≥)\s*(\d+(?:[,.]?\d{3})*)/i,
                /(\d+(?:[,.]?\d{3})*)\s*(?:ƒë·ªìng|vnƒë|vnd|k|ngh√¨n|ng√†n)/i,
                /(?:ti·ªÅn|s·ªë ti·ªÅn|th√†nh ti·ªÅn)\s*(\d+(?:[,.]?\d{3})*)/i,
                /(\d{4,})/g
            ];
            
            const allNumbers = [];
            
            for (const pattern of moneyPatterns) {
                if (pattern.global) {
                    const matches = [...processedText.matchAll(pattern)];
                    for (const match of matches) {
                        const num = parseInt(match[0].replace(/[,.]/g, ''));
                        if (num > 0) allNumbers.push(num);
                    }
                } else {
                    const match = processedText.match(pattern);
                    if (match) {
                        const num = parseInt(match[1].replace(/[,.]/g, ''));
                        if (num > 0) allNumbers.push(num);
                    }
                }
            }
            
            if (allNumbers.length > 0) {
                total = Math.max(...allNumbers);
            }
            
            console.log('C√°c s·ªë t√¨m th·∫•y:', allNumbers, 'Ch·ªçn:', total);
            
            return {
                storeName: storeName || 'Kh√¥ng x√°c ƒë·ªãnh',
                date: date || new Date().toISOString().split('T')[0],
                total: total,
                items: []
            };
        }
        
        function closeVoice() {
            if (recognition) {
                recognition.stop();
            }
            document.getElementById('voiceModal').classList.add('hidden');
            document.getElementById('voiceAnimation').classList.add('hidden');
        }

        async function processImage() {
            if (!uploadedFile) return;
            const loadingSection = document.getElementById('loadingSection');
            const resultsContent = document.getElementById('resultsContent');
            const previewContainer = document.getElementById('previewContainer');
            const saveBtn = document.getElementById('saveBtn');
            const selectedLanguage = document.getElementById('languageSelect').value;

            loadingSection.classList.remove('hidden');
            previewContainer.classList.add('hidden');

            try {
                let ocrLanguage = selectedLanguage === 'auto' ? 'eng+vie' : selectedLanguage;
                
                const { data: { text } } = await Tesseract.recognize(uploadedFile, ocrLanguage, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            loadingSection.innerHTML = `<div class="loading-spinner mx-auto"></div><p class="text-gray-500 mt-4">ƒêang nh·∫≠n di·ªán vƒÉn b·∫£n... ${progress}%</p>`;
                        }
                    },
                    errorHandler: err => console.error('OCR Error:', err)
                });
                
                if (!text || text.trim().length < 10) {
                    throw new Error('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c vƒÉn b·∫£n t·ª´ h√¨nh ·∫£nh');
                }

                currentRawText = text;
                currentReceiptInfo = await parseWithGemini(currentRawText);
                displayResults(currentReceiptInfo, currentRawText);
                
                document.getElementById('copyBtn').classList.remove('hidden');
                document.getElementById('exportBtn').classList.remove('hidden');
                document.getElementById('saveExpenseBtn').classList.remove('hidden');
                saveBtn.classList.remove('hidden');

            } catch (error) {
                console.error('OCR Error:', error);
                resultsContent.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg"><strong>L·ªói x·ª≠ l√Ω:</strong> ${error.message || 'Kh√¥ng th·ªÉ ƒë·ªçc ƒë∆∞·ª£c h√≥a ƒë∆°n. Vui l√≤ng th·ª≠ v·ªõi h√¨nh ·∫£nh r√µ n√©t h∆°n.'}</div>`;
            } finally {
                loadingSection.classList.add('hidden');
            }
        }

        // --- H√†m ph√¢n t√≠ch th√¥ng minh b·∫±ng Gemini AI ---
        async function parseWithGemini(ocrText) {
            try {
                const prompt = `Ph√¢n t√≠ch vƒÉn b·∫£n h√≥a ƒë∆°n v√† tr·∫£ v·ªÅ JSON v·ªõi: storeName, date (YYYY-MM-DD), total (s·ªë), items (array). VƒÉn b·∫£n: ${ocrText}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyCOj3-xvtYhVbk4hx53wC1D8umPCnty7Zg`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error('API Error');
                
                const result = await response.json();
                const jsonString = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                return JSON.parse(jsonString);
            } catch (error) {
                console.error('Gemini Error:', error);
                return parseReceiptFallback(ocrText);
            }
        }
        
        function parseReceiptFallback(text) {
            const lines = text.split('\n').filter(line => line.trim());
            
            let total = 0;
            const totalPatterns = [/t·ªïng.*?(\d{1,3}(?:[,.]?\d{3})*)/i, /total.*?(\d{1,3}(?:[,.]?\d{3})*)/i];
            for (const line of lines) {
                for (const pattern of totalPatterns) {
                    const match = line.match(pattern);
                    if (match) {
                        total = parseInt(match[1].replace(/[,.]/g, ''));
                        break;
                    }
                }
                if (total > 0) break;
            }
            
            let storeName = lines.find(line => line.length > 3 && !line.match(/^\d/)) || '';
            let date = '';
            const dateMatch = text.match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
            if (dateMatch) date = dateMatch[1];
            
            return { storeName, date, total, items: [] };
        }

        function clearResults() {
            document.getElementById('resultsContent').innerHTML = `<div class="text-center text-gray-400 py-16"><div class="text-5xl mb-4">üìã</div><p>T·∫£i l√™n h√¨nh ·∫£nh h√≥a ƒë∆°n ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch</p></div>`;
            document.getElementById('copyBtn').classList.add('hidden');
            document.getElementById('exportBtn').classList.add('hidden');
            document.getElementById('saveExpenseBtn').classList.add('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
        }

        async function saveToExpense() {
            if (!currentReceiptInfo || !currentReceiptInfo.total) {
                alert('Kh√¥ng c√≥ th√¥ng tin s·ªë ti·ªÅn ƒë·ªÉ l∆∞u!');
                return;
            }

            const token = localStorage.getItem('token');
            if (!token) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u chi ti√™u!');
                window.location.href = 'index.html';
                return;
            }

            const transactionData = {
                loai: 'chi',
                so_tien: currentReceiptInfo.total,
                mo_ta: `H√≥a ƒë∆°n t·ª´ ${currentReceiptInfo.storeName || 'C·ª≠a h√†ng'} - ${currentReceiptInfo.date || ''}`,
                ngay: currentReceiptInfo.date || new Date().toISOString().split('T')[0]
            };

            console.log('G·ª≠i d·ªØ li·ªáu:', transactionData);

            try {
                const response = await fetch('http://localhost:5000/api/giao-dich', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(transactionData)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    alert('‚úÖ ƒê√£ l∆∞u v√†o chi ti√™u th√†nh c√¥ng!');
                } else {
                    const errorText = await response.text();
                    console.error('L·ªói response:', errorText);
                    try {
                        const error = JSON.parse(errorText);
                        alert(`‚ùå L·ªói: ${error.message || 'Kh√¥ng th·ªÉ l∆∞u chi ti√™u'}`);
                    } catch {
                        alert(`‚ùå L·ªói: ${errorText}`);
                    }
                }
            } catch (error) {
                console.error('L·ªói khi l∆∞u chi ti√™u:', error);
                alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server! Ki·ªÉm tra backend ƒëang ch·∫°y tr√™n port 5000');
            }
        }

        function displayResults(receiptInfo, rawText) {
            const resultsContent = document.getElementById('resultsContent');
            const itemsHtml = receiptInfo.items.length > 0 ? 
                receiptInfo.items.map(item => `
                    <tr>
                        <td class="p-3 text-sm text-gray-600 whitespace-nowrap">${item.name}</td>
                        <td class="p-3 text-sm text-gray-600 whitespace-nowrap">${item.quantity}</td>
                        <td class="p-3 text-sm text-gray-600 text-right whitespace-nowrap">${item.price} VNƒê</td>
                    </tr>
                `).join('') : 
                '<tr><td colspan="3" class="p-4 text-center text-gray-400">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m.</td></tr>';

            resultsContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 rounded-lg bg-gray-50 border border-gray-200"><div class="text-xs font-semibold text-gray-500 uppercase">T√™n C·ª≠a H√†ng</div><div class="mt-1 text-lg font-medium text-gray-800">${receiptInfo.storeName || 'Kh√¥ng x√°c ƒë·ªãnh'}</div></div>
                    <div class="p-4 rounded-lg bg-gray-50 border border-gray-200"><div class="text-xs font-semibold text-gray-500 uppercase">Ng√†y</div><div class="mt-1 text-lg font-medium text-gray-800">${receiptInfo.date || 'Kh√¥ng x√°c ƒë·ªãnh'}</div></div>
                </div>

                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Danh S√°ch S·∫£n Ph·∫©m</h3>
                    <div class="overflow-x-auto rounded-lg shadow-sm border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200 bg-white">
                            <thead class="bg-gray-50"><tr><th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">T√™n S·∫£n Ph·∫©m</th><th class="p-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">S·ªë L∆∞·ª£ng</th><th class="p-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Gi√°</th></tr></thead>
                            <tbody class="divide-y divide-gray-200">${itemsHtml}</tbody>
                        </table>
                    </div>
                </div>

                ${receiptInfo.total ? `<div class="mt-6 flex justify-end"><div class="p-4 rounded-lg bg-indigo-50 gradient-bg text-white shadow-md"><div class="text-sm font-medium uppercase">T·ªïng C·ªông</div><div class="mt-1 text-3xl font-extrabold">${receiptInfo.total} VNƒê</div></div></div>` : ''}
                
                <div class="mt-6"><details class="p-4 rounded-lg bg-gray-50 border border-gray-200"><summary class="cursor-pointer font-medium text-gray-700">Xem VƒÉn B·∫£n G·ªëc</summary><pre class="mt-4 text-xs text-gray-600 whitespace-pre-wrap">${rawText}</pre></details></div>`;
        }

        // --- Firebase Firestore Functions ---
        async function saveReceipt() {
    if (!currentReceiptInfo) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ l∆∞u!');
        return;
    }
    if (!userId) {
        alert('Kh√¥ng th·ªÉ l∆∞u. Vui l√≤ng ƒëƒÉng nh·∫≠p.');
        return;
    }

    const docData = {
        storeName: currentReceiptInfo.storeName,
        date: currentReceiptInfo.date,
        total: currentReceiptInfo.total,
        items: currentReceiptInfo.items,
        rawText: currentRawText,
        timestamp: window.firebase.serverTimestamp(),
        userId: userId,
    };

    try {
        const { collection, addDoc } = window.firebase;
        await addDoc(collection(db, "users", userId, "invoices"), docData);
        alert('‚úÖ ƒê√£ l∆∞u h√≥a ƒë∆°n th√†nh c√¥ng!');
        document.getElementById('saveBtn').classList.add('hidden');
        loadSavedBills();
    } catch (error) {
        console.error(" L·ªói khi l∆∞u t√†i li·ªáu:", error);
        alert(' L·ªói khi l∆∞u h√≥a ƒë∆°n.');
    }
}


        async function loadSavedBills() {
    const container = document.getElementById('savedBillsContainer');
    const searchBox = document.getElementById('searchBox');
    const searchTerm = searchBox.value.toLowerCase();

    if (!userId) {
        container.innerHTML = `<p class="text-center text-gray-400 py-4">ƒêang k·∫øt n·ªëi...</p>`;
        return;
    }

    let allBills = [];
    try {
        const { collection, query, getDocs } = window.firebase;
        const q = query(collection(db, "users", userId, "invoices"));  // üîπ d√πng path chu·∫©n
        const querySnapshot = await getDocs(q);
        querySnapshot.forEach(doc => {
            allBills.push({ id: doc.id, ...doc.data() });
        });
    } catch (error) {
        console.error(" L·ªói khi t·∫£i h√≥a ƒë∆°n:", error);
        container.innerHTML = `<p class="text-center text-red-500 py-4">L·ªói khi t·∫£i h√≥a ƒë∆°n.</p>`;
        return;
    }

    const filteredBills = allBills.filter(bill =>
        (bill.storeName && bill.storeName.toLowerCase().includes(searchTerm)) ||
        (bill.date && bill.date.includes(searchTerm)) ||
        (bill.total && String(bill.total).includes(searchTerm))
    );

    if (filteredBills.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-400 py-4">Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n n√†o.</p>`;
        return;
    }

    container.innerHTML = filteredBills.map(bill => `
        <div class="p-4 bg-gray-50 border border-gray-200 rounded-lg mb-2 flex justify-between items-center">
            <div class="cursor-pointer flex-1" onclick="viewSavedBill('${bill.id}')">
                <div class="font-semibold text-gray-800">${bill.storeName || 'Kh√¥ng t√™n'}</div>
                <div class="text-sm text-gray-500">Ng√†y: ${bill.date || 'N/A'} - T·ªïng: ${bill.total || 'N/A'} VNƒê</div>
            </div>
            <button class="text-red-500 hover:text-red-700 font-bold ml-4" onclick="deleteSavedBill('${bill.id}')">üóëÔ∏è</button>
        </div>
    `).join('');
}


        async function viewSavedBill(id) {
    if (!userId) return;
    try {
        const { doc, getDoc } = window.firebase;
        const docRef = doc(db, "users", userId, "invoices", id);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
            const bill = docSnap.data();
            currentReceiptInfo = {
                storeName: bill.storeName,
                date: bill.date,
                total: bill.total,
                items: bill.items || [],
            };
            currentRawText = bill.rawText;
            displayResults(currentReceiptInfo, currentRawText);
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('previewContainer').classList.add('hidden');
            document.getElementById('copyBtn').classList.remove('hidden');
            document.getElementById('exportBtn').classList.remove('hidden');
            switchTab('input'); // Quay l·∫°i tab nh·∫≠p li·ªáu ƒë·ªÉ xem k·∫øt qu·∫£
        }
    } catch (error) {
        console.error(" L·ªói khi xem h√≥a ƒë∆°n:", error);
        alert(' L·ªói khi t·∫£i h√≥a ƒë∆°n ƒë√£ l∆∞u.');
    }
}

async function deleteSavedBill(id) {
    if (!userId) return;
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√≥a ƒë∆°n n√†y kh√¥ng?")) return;

    try {
        const { doc, deleteDoc } = window.firebase;
        const docRef = doc(db, "users", userId, "invoices", id);
        await deleteDoc(docRef);
        alert("‚úÖ ƒê√£ x√≥a h√≥a ƒë∆°n th√†nh c√¥ng!");
        loadSavedBills(); // Refresh danh s√°ch sau khi x√≥a
    } catch (error) {
        console.error(" L·ªói khi x√≥a h√≥a ƒë∆°n:", error);
        alert(" L·ªói khi x√≥a h√≥a ƒë∆°n.");
    }
}



        function copyToClipboard() {
            const resultsContent = document.getElementById('resultsContent');
            if (!resultsContent.textContent.trim()) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao ch√©p!'); return; }
            navigator.clipboard.writeText(resultsContent.textContent).then(() => { alert('‚úÖ ƒê√£ sao ch√©p th√¥ng tin h√≥a ƒë∆°n v√†o clipboard!'); }).catch(() => { alert('‚ùå Kh√¥ng th·ªÉ sao ch√©p.'); });
        }

        function exportToExcel() {
            if (!currentReceiptInfo) { alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!'); return; }
            const info = currentReceiptInfo;
            const ws_data = [["T√™n C·ª≠a H√†ng", info.storeName], ["Ng√†y", info.date], [], ["T√™n S·∫£n Ph·∫©m", "S·ªë L∆∞·ª£ng", "Gi√°"], ...info.items.map(item => [item.name, item.quantity, item.price]), [], ["T·ªïng C·ªông", "", info.total]];
            const wb = XLSX.utils.book_new(); const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "HoaDon");
            XLSX.writeFile(wb, `HoaDon_${info.date || Date.now()}.xlsx`);
        }
    </script>
</body>
</html>
